<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Requests - SPATRAK Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              violet: {
                200: "#ddd6fe",
                400: "#a78bfa",
                900: "#4c1d95",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="h-full bg-gradient-to-br from-violet-200 via-white to-violet-400"
  >
    <div class="flex h-full">
      <!-- Sidebar -->
      <div id="Sidebar-container"></div>

      <!-- Main Content Area -->
      <div class="flex-1 lg:ml-64">
        <!-- Header -->
        <header
          class="bg-white/80 backdrop-blur-md text-violet-900 shadow-lg fixed w-full lg:w-[calc(100%-16rem)] top-0 z-40"
        >
          <div
            class="container mx-auto px-4 py-3 flex justify-between items-center"
          >
            <div class="flex items-center space-x-4">
              <button
                id="sidebarToggle"
                class="lg:hidden bg-violet-100 text-violet-900 p-2 rounded-lg"
              >
                <i class="fas fa-bars"></i>
              </button>
              <h1 class="text-2xl font-bold">Requests Management</h1>
            </div>
            <div class="flex items-center space-x-4">
              <button
                class="bg-violet-100 hover:bg-violet-200 text-violet-900 px-4 py-2 rounded-lg transition duration-300"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
              </button>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 pt-20 pb-8 overflow-y-auto">
          <!-- Filters and Search -->
          <div
            class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-10 flex flex-col md:flex-row justify-between items-center gap-6"
          >
            <div class="flex items-center space-x-4 w-full md:w-auto">
              <select
                id="statusFilter"
                class="bg-violet-50 border border-violet-200 rounded-lg px-6 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-violet-400 text-violet-900 transition-all"
              >
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="accepted">accepted</option>
                <option value="rejected">Rejected</option>
              </select>
              <!-- <select
                id="typeFilter"
                class="bg-violet-50 border border-violet-200 rounded-lg px-6 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-violet-400 text-violet-900 transition-all"
              >
                <option value="all">All Types</option>
                <option value="verification">Verification</option>
                <option value="payment">Payment</option>
                <option value="support">Support</option>
              </select> -->
            </div>
            <div
              class="flex items-center space-x-4 w-full md:w-auto mt-4 md:mt-0"
            >
              <div class="relative w-full md:w-auto">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search requests..."
                  class="bg-violet-50 border border-violet-200 rounded-lg pl-12 pr-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-violet-400 text-violet-900 w-full transition-all"
                />
                <i
                  class="fas fa-search absolute left-4 top-3.5 text-violet-900 text-lg"
                ></i>
              </div>
              <button
                id="applyFilters"
                class="bg-violet-100 hover:bg-violet-200 text-violet-900 px-6 py-3 rounded-lg text-lg font-semibold shadow transition duration-300 flex items-center"
              >
                <i class="fas fa-filter mr-2"></i>Apply Filters
              </button>
            </div>
          </div>

          <!-- Requests Table -->
          <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-violet-50">
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Request ID
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      User
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Type
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Date
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Status
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="requestsTableBody"
                  class="divide-y divide-violet-100"
                >
                  <!-- سيتم ملؤه بالبيانات من الـ API -->
                  <tr>
                    <td
                      colspan="6"
                      class="px-6 py-4 text-center text-violet-900"
                    >
                      Loading requests...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4"
            >
              <div
                id="paginationInfo"
                class="text-base text-violet-600 font-semibold"
              >
                Loading...
              </div>
              <div class="flex items-center space-x-2">
                <button
                  id="prevPage"
                  class="bg-violet-50 text-violet-900 px-4 py-2 rounded-lg hover:bg-violet-100 transition duration-300 font-bold"
                >
                  Previous
                </button>
                <div id="pageNumbers" class="flex items-center space-x-2">
                  <!-- سيتم ملؤه بالبيانات -->
                </div>
                <button
                  id="nextPage"
                  class="bg-violet-50 text-violet-900 px-4 py-2 rounded-lg hover:bg-violet-100 transition duration-300 font-bold"
                >
                  Next
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Edit Request Modal -->
    <!-- Edit Request Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-violet-900">Edit Request</h3>
            <button
              onclick="closeEditModal()"
              class="text-violet-400 hover:text-violet-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <div class="space-y-4">
            <input type="hidden" id="editRequestId" />

            <div>
              <label class="block text-sm font-medium text-violet-700 mb-1"
                >Status</label
              >
              <select
                id="editRequestStatus"
                class="w-full px-4 py-2 border border-violet-200 rounded-lg focus:ring-2 focus:ring-violet-400 focus:border-violet-400"
              >
                <option value="pending">Pending</option>
                <option value="accepted">accepted</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-violet-700 mb-1"
                >Message</label
              >
              <textarea
                id="editRequestMessage"
                rows="3"
                class="w-full px-4 py-2 border border-violet-200 rounded-lg focus:ring-2 focus:ring-violet-400 focus:border-violet-400"
                placeholder="Enter your message here..."
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-violet-700 mb-1"
                >Certificate File (if accepted)</label
              >
              <input
                type="file"
                id="editRequestFile"
                class="w-full px-4 py-2 border border-violet-200 rounded-lg focus:ring-2 focus:ring-violet-400 focus:border-violet-400"
                accept=".pdf,.doc,.docx"
              />
            </div>
          </div>

          <div class="flex justify-end space-x-3 mt-6">
            <button
              onclick="closeEditModal()"
              class="px-4 py-2 text-violet-700 bg-violet-100 rounded-lg hover:bg-violet-200 transition"
            >
              Cancel
            </button>
            <button
              id="saveChangesBtn"
              onclick="submitRequestChanges()"
              class="px-4 py-2 text-white bg-violet-600 rounded-lg hover:bg-violet-700 transition"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // متغيرات لتخزين عناصر المودال
      let editModalElements = {
        modal: null,
        idField: null,
        statusField: null,
        messageField: null,
        fileField: null,
        saveBtn: null,
      };

      // تهيئة عناصر المودال عند تحميل الصفحة
      function initEditModal() {
        editModalElements = {
          modal: document.getElementById("editModal"),
          idField: document.getElementById("editRequestId"),
          statusField: document.getElementById("editRequestStatus"),
          messageField: document.getElementById("editRequestMessage"),
          fileField: document.getElementById("editRequestFile"),
          saveBtn: document.getElementById("saveChangesBtn"),
        };

        // التحقق من وجود جميع العناصر
        for (const [key, element] of Object.entries(editModalElements)) {
          if (!element) {
            console.error(`Edit modal element not found: ${key}`);
            return false;
          }
        }
        return true;
      }

      // فتح مودال التحرير
      function openEditModal(requestId) {
        if (!initEditModal()) {
          console.error("Cannot open edit modal - elements not initialized");
          return;
        }

        // Verify each element exists before using it
        const elements = {
          idField: editModalElements.idField,
          statusField: editModalElements.statusField,
          messageField: editModalElements.messageField,
          fileField: editModalElements.fileField,
        };

        for (const [key, element] of Object.entries(elements)) {
          if (!element) {
            console.error(
              `Element ${key} is null. Please check if the element with ID 'editRequest${
                key.charAt(0).toUpperCase() + key.slice(1)
              }' exists in the DOM.`
            );
            return;
          }
        }

        const request = allRequests.find((req) => req._id === requestId);
        if (!request) {
          console.error("Request not found:", requestId);
          return;
        }

        try {
          // تعبئة البيانات
          editModalElements.idField.value = requestId;
          editModalElements.statusField.value = request.status || "pending";
          editModalElements.messageField.value = request.adminNotes || "";
          editModalElements.fileField.value = "";

          // عرض المودال
          editModalElements.modal.classList.remove("hidden");
          editModalElements.modal.classList.add("flex");
          document.body.style.overflow = "hidden";
        } catch (error) {
          console.error("Error in openEditModal:", error);
          alert("Error opening edit modal. Please try again.");
        }
      }

      // إغلاق مودال التحرير
      function closeEditModal() {
        if (editModalElements.modal) {
          editModalElements.modal.classList.add("hidden");
          editModalElements.modal.classList.remove("flex");
          document.body.style.overflow = "auto";
        }
      }

      // إرسال التغييرات إلى API
      async function submitRequestChanges() {
        if (!editModalElements.saveBtn) return;

        try {
          // تعطيل الزر أثناء المعالجة
          editModalElements.saveBtn.disabled = true;
          editModalElements.saveBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

          const requestId = editModalElements.idField.value;
          if (!requestId) {
            throw new Error("Request ID is missing");
          }

          const formData = new FormData();
          formData.append("status", editModalElements.statusField.value);
          formData.append("message", editModalElements.messageField.value);

          if (editModalElements.fileField.files[0]) {
            formData.append("reportFile", editModalElements.fileField.files[0]);
          }

          const response = await fetch(
            `https://backend-production-816c.up.railway.app/api/requests/${requestId}/reply`,
            {
              method: "PUT",
              body: formData,
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to update request");
          }

          const result = await response.json();
          console.log("Update successful:", result);

          // تحديث الواجهة
          updateRequestInUI(
            requestId,
            editModalElements.statusField.value,
            editModalElements.messageField.value
          );

          // إغلاق المودال
          closeEditModal();

          // عرض رسالة نجاح
          alert("Request updated successfully!");
        } catch (error) {
          console.error("Update error:", error);
          alert(`Error: ${error.message || "Failed to update request"}`);
        } finally {
          // إعادة تعيين الزر
          if (editModalElements.saveBtn) {
            editModalElements.saveBtn.disabled = false;
            editModalElements.saveBtn.innerHTML = "Save Changes";
          }
        }
      }

      // تحديث الواجهة بعد التعديل
      function updateRequestInUI(requestId, newStatus, message) {
        try {
          const requestIndex = allRequests.findIndex(
            (req) => req._id === requestId
          );
          if (requestIndex === -1) return;

          // تحديث البيانات المحلية
          allRequests[requestIndex].status = newStatus;
          allRequests[requestIndex].adminNotes = message;

          // تحديث الجدول
          const row = document.querySelector(
            `tr[data-request-id="${requestId}"]`
          );
          if (!row) return;

          const statusCell = row.querySelector("td:nth-child(5) span");
          if (statusCell) {
            statusCell.textContent =
              newStatus === "accepted"
                ? "accepted"
                : newStatus === "rejected"
                ? "Rejected"
                : "Pending";

            statusCell.className = `px-4 py-2 rounded-full text-base font-bold shadow capitalize ${
              newStatus === "accepted"
                ? "bg-green-100 text-green-800"
                : newStatus === "rejected"
                ? "bg-red-100 text-red-800"
                : "bg-yellow-100 text-yellow-800"
            }`;
          }
        } catch (error) {
          console.error("Error updating UI:", error);
        }
      }

      // تهيئة المودال عند تحميل الصفحة
      document.addEventListener("DOMContentLoaded", function () {
        initEditModal();
      });
    </script>
    <!-- View Request Modal -->
    <!-- View Request Modal -->
    <div
      id="viewModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-y-auto"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-8 max-h-[90vh] overflow-hidden"
      >
        <!-- Modal Header -->
        <div
          class="sticky top-0 bg-white border-b border-violet-100 px-6 py-4 z-10"
        >
          <div class="flex justify-between items-center">
            <h3 class="text-2xl font-bold text-violet-900">
              <i class="fas fa-file-alt text-violet-500 mr-3"></i>
              Request Details
            </h3>
            <button
              onclick="closeModal('viewModal')"
              class="text-violet-400 hover:text-violet-600 transition-colors"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px)">
          <div id="requestDetailsContent" class="space-y-6">
            <!-- Example of how the content will be structured -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Basic Information Section -->
              <div class="bg-violet-50 rounded-lg p-5">
                <h4 class="font-bold text-violet-800 mb-4 text-lg">
                  Basic Information
                </h4>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <p class="text-sm font-semibold text-violet-600">
                      Request ID
                    </p>
                    <p class="text-violet-900">REQ-123456</p>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-violet-600">Status</p>
                    <p class="text-violet-900">Pending</p>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-violet-600">
                      Created At
                    </p>
                    <p class="text-violet-900">2023-05-15 14:30</p>
                  </div>
                </div>
              </div>

              <!-- Personal Information Section -->
              <div class="bg-violet-50 rounded-lg p-5">
                <h4 class="font-bold text-violet-800 mb-4 text-lg">
                  Personal Information
                </h4>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <p class="text-sm font-semibold text-violet-600">
                      Full Name
                    </p>
                    <p class="text-violet-900">John Doe</p>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-violet-600">Email</p>
                    <p class="text-violet-900">john.doe@example.com</p>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-violet-600">Phone</p>
                    <p class="text-violet-900">+1234567890</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loading Indicator (will be replaced with actual content) -->
            <div class="flex justify-center items-center py-12 hidden">
              <div class="text-center">
                <i
                  class="fas fa-spinner fa-spin text-4xl text-violet-600 mb-3"
                ></i>
                <p class="text-violet-700 font-medium">
                  Loading request details...
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div
          class="sticky bottom-0 bg-gradient-to-t from-white via-white to-white/80 px-6 py-4 border-t border-violet-100"
        >
          <div class="flex justify-end">
            <button
              onclick="closeModal('viewModal')"
              class="px-5 py-2.5 text-violet-700 bg-violet-100 rounded-xl hover:bg-violet-200 transition-all font-medium flex items-center shadow-sm hover:shadow-md"
            >
              <i class="fas fa-times mr-2"></i>
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // المتغيرات العامة
      let allRequests = [];
      let currentPage = 1;
      const itemsPerPage = 10;
      let currentFilters = {
        status: "all",
        type: "all",
        search: "",
      };

      // تهيئة الصفحة
      document.addEventListener("DOMContentLoaded", function () {
        fetchRequests();

        // إعداد معالجات الأحداث
        document
          .getElementById("applyFilters")
          .addEventListener("click", applyFilters);
        document
          .getElementById("searchInput")
          .addEventListener("keyup", function (e) {
            if (e.key === "Enter") applyFilters();
          });
        document
          .getElementById("prevPage")
          .addEventListener("click", goToPrevPage);
        document
          .getElementById("nextPage")
          .addEventListener("click", goToNextPage);

        // إغلاق المودال عند النقر خارجها
        document
          .getElementById("editModal")
          .addEventListener("click", function (e) {
            if (e.target === e.currentTarget) closeModal("editModal");
          });
        document
          .getElementById("viewModal")
          .addEventListener("click", function (e) {
            if (e.target === e.currentTarget) closeModal("viewModal");
          });
      });

      // جلب الطلبات من API
      function fetchRequests() {
        fetch("https://backend-production-816c.up.railway.app/api/requests/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            // معالجة البيانات المستلمة
            if (data && Array.isArray(data)) {
              allRequests = data;
            } else if (data && data.requests && Array.isArray(data.requests)) {
              allRequests = data.requests;
            } else {
              throw new Error("Invalid data format from API");
            }

            // عرض الطلبات
            applyFilters();
          })
          .catch((error) => {
            console.error("Error fetching requests:", error);
            document.getElementById("requestsTableBody").innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-violet-900">
                                Error loading requests. Please try again later.
                            </td>
                        </tr>
                    `;
          });
      }

      // تطبيق الفلاتر
      function applyFilters() {
        currentFilters = {
          status: document.getElementById("statusFilter").value,
          search: document.getElementById("searchInput").value.toLowerCase(),
        };

        currentPage = 1; // العودة للصفحة الأولى عند تطبيق فلاتر جديدة
        renderRequests();
      }

      // عرض الطلبات مع التصفية والترتيب
      function renderRequests() {
        let filteredRequests = allRequests.filter((request) => {
          // تصفية حسب الحالة
          if (
            currentFilters.status !== "all" &&
            request.status !== currentFilters.status
          ) {
            return false;
          }

          // تصفية حسب النوع (إذا كان موجودًا في البيانات)
          if (
            currentFilters.type !== "all" &&
            request.type &&
            request.type !== currentFilters.type
          ) {
            return false;
          }

          // تصفية حسب البحث
          if (currentFilters.search) {
            const searchStr = `${request.id || ""} ${request.userName || ""} ${
              request.user?.name || ""
            } ${request.type || ""}`.toLowerCase();
            if (!searchStr.includes(currentFilters.search)) {
              return false;
            }
          }

          return true;
        });

        // ترتيب الطلبات حسب التاريخ (الأحدث أولاً)
        filteredRequests.sort(
          (a, b) =>
            new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)
        );

        // التقسيم إلى صفحات
        const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedRequests = filteredRequests.slice(
          startIndex,
          startIndex + itemsPerPage
        );

        // عرض الطلبات في الجدول
        const tableBody = document.getElementById("requestsTableBody");
        tableBody.innerHTML = "";

        if (paginatedRequests.length === 0) {
          tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-violet-900">
                            No requests found matching your criteria
                        </td>
                    </tr>
                `;
        } else {
          paginatedRequests.forEach((request) => {
            const requestDate = request.createdAt
              ? new Date(request.createdAt).toLocaleDateString()
              : "N/A";
            const userName = request.userName || request.user?.name || "N/A";
            const requestType = request.type || "N/A";

            // تحديد لون الحالة
            let statusClass = "bg-gray-100 text-gray-800";
            if (request.status === "accepted") {
              statusClass = "bg-green-100 text-green-800";
            } else if (request.status === "rejected") {
              statusClass = "bg-red-100 text-red-800";
            } else if (request.status === "pending") {
              statusClass = "bg-yellow-100 text-yellow-800";
            }

            const row = document.createElement("tr");
            row.className = "hover:bg-violet-50 transition-all";
            row.dataset.requestId = request._id;
            row.innerHTML = `
                        <td class="px-6 py-5 whitespace-nowrap text-violet-900 text-lg font-semibold">${
                          request._id || "N/A"
                        }</td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex items-center space-x-3">
                                <span class="text-violet-900 text-lg font-semibold">${
                                  request.firstName
                                }</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-violet-900 text-lg">${
                          request.address
                        }</td>
                        <td class="px-6 py-5 whitespace-nowrap text-violet-900 text-lg">${requestDate}</td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="${statusClass} px-4 py-2 rounded-full text-base font-bold shadow capitalize">${
              request.status || "unknown"
            }</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <button onclick="openEditModal('${
                                  request._id
                                }')" 
                                        class="text-white bg-violet-600 hover:bg-violet-700 px-3 py-1 rounded-lg transition flex items-center">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button onclick="openViewModal('${
                                  request._id
                                }')" 
                                        class="text-violet-700 bg-violet-100 hover:bg-violet-200 px-3 py-1 rounded-lg transition flex items-center">
                                    <i class="fas fa-eye mr-1"></i> View
                                </button>
                            </div>
                        </td>
                    `;
            tableBody.appendChild(row);
          });
        }

        // تحديث معلومات الترقيم
        updatePaginationInfo(filteredRequests.length, totalPages);
      }

      // تحديث معلومات الترقيم
      function updatePaginationInfo(totalItems, totalPages) {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);

        document.getElementById(
          "paginationInfo"
        ).textContent = `Showing ${startItem} to ${endItem} of ${totalItems} entries`;

        const pageNumbersContainer = document.getElementById("pageNumbers");
        pageNumbersContainer.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          const pageBtn = document.createElement("button");
          pageBtn.textContent = i;
          pageBtn.className = `bg-${
            i === currentPage ? "violet-100" : "violet-50"
          } text-violet-900 px-4 py-2 rounded-lg hover:bg-violet-100 transition duration-300 font-bold`;
          pageBtn.addEventListener("click", () => goToPage(i));
          pageNumbersContainer.appendChild(pageBtn);
        }

        // تحديث حالة أزرار الصفحة السابقة/التالية
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled =
          currentPage === totalPages;
      }

      // التنقل بين الصفحات
      function goToPage(page) {
        currentPage = page;
        renderRequests();
      }

      function goToPrevPage() {
        if (currentPage > 1) {
          currentPage--;
          renderRequests();
        }
      }

      function goToNextPage() {
        const totalPages = Math.ceil(allRequests.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderRequests();
        }
      }

      // دالة للتحقق من وجود الملف وتحميله
      async function downloadFile(url, fileName) {
        try {
          console.log("Attempting to download file from:", url);

          // التحقق من صحة الرابط
          if (!url || url === "undefined" || url === "null") {
            throw new Error("Invalid file URL");
          }

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept:
                "application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            },
          });

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          // التحقق من نوع الملف
          const contentType = response.headers.get("content-type");
          if (!contentType) {
            throw new Error("No content type received from server");
          }

          console.log("File content type:", contentType);

          // تحويل الملف إلى blob
          const blob = await response.blob();

          if (blob.size === 0) {
            throw new Error("Received empty file");
          }

          console.log("File size:", blob.size, "bytes");

          // إنشاء رابط مؤقت للتحميل
          const downloadUrl = window.URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = downloadUrl;
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(downloadUrl);
        } catch (error) {
          console.error("Download error details:", {
            error: error.message,
            url: url,
            fileName: fileName,
          });

          let errorMessage =
            "Sorry, there was a problem downloading the file. ";
          if (error.message.includes("Invalid file URL")) {
            errorMessage += "The file URL is invalid.";
          } else if (error.message.includes("Server responded")) {
            errorMessage += "The server could not provide the file.";
          } else if (error.message.includes("No content type")) {
            errorMessage += "The server did not specify the file type.";
          } else if (error.message.includes("empty file")) {
            errorMessage += "The file appears to be empty.";
          } else {
            errorMessage += "Please try again later.";
          }

          alert(errorMessage);
        }
      }

      // عرض تفاصيل الطلب
      function renderRequestDetails(request) {
        const detailsContent = document.getElementById("requestDetailsContent");
        const requestDate = request.createdAt
          ? new Date(request.createdAt).toLocaleString()
          : "N/A";
        const updatedDate = request.updatedAt
          ? new Date(request.updatedAt).toLocaleString()
          : "N/A";

        // تحديد لون الحالة
        let statusClass = "bg-gray-100 text-gray-800";
        if (request.status === "accepted") {
          statusClass = "bg-green-100 text-green-800";
        } else if (request.status === "rejected") {
          statusClass = "bg-red-100 text-red-800";
        } else if (request.status === "pending") {
          statusClass = "bg-yellow-100 text-yellow-800";
        }

        detailsContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- معلومات الطلب الأساسية -->
            <div class="space-y-4">
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Basic Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-md font-medium text-violet-600">Request ID</p>
                            <p class="text-slate-600">${
                              request._id || "N/A"
                            }</p>
                        </div>
                        <div classname="ml-5">
                            <p class="text-md font-medium text-violet-600">Status</p>
                            <p >
                                <span class="${statusClass} px-3 py-1 rounded-full text-sm">${
          request.status || "N/A"
        }</span>
                            </p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Created At</p>
                            <p class="text-slate-600">${requestDate}</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Updated At</p>
                            <p class="text-slate-600">${updatedDate}</p>
                        </div>
                    </div>
                </div>

                <!-- معلومات الشخصية -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Personal Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-md font-medium text-violet-600">First Name</p>
                            <p class="text-slate-600">${
                              request.firstName || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Last Name</p>
                            <p class="text-slate-600" >${
                              request.lastName || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Given Last Name</p>
                            <p class="text-slate-600">${
                              request.givenLastName || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Birth Date</p>
                            <p  class="text-slate-600">${
                              request.birthDate
                                ? `${request.birthDate.day}/${request.birthDate.month}/${request.birthDate.year}`
                                : "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Email</p>
                            <p class="text-slate-600" >${
                              request.email || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Phone</p>
                            <p class="text-slate-600">${
                              request.phone || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Address</p>
                            <p class="text-slate-600">${
                              request.address || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Country</p>
                            <p class="text-slate-600">${
                              request.country || "N/A"
                            }</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- معلومات التعليم والشركة -->
            <div class="space-y-4">
                <!-- معلومات التعليم -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Education Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-md font-medium text-violet-600">Establishment</p>
                            <p class="text-slate-600" >${
                              request.establishment || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Program</p>
                            <p class="text-slate-600">${
                              request.program || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Graduation Year</p>
                            <p class="text-slate-600" >${
                              request.graduationYear || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Internal Reference</p>
                            <p class="text-slate-600" >${
                              request.internalRef || "N/A"
                            }</p>
                        </div>
                    </div>
                </div>

                <!-- معلومات الشركة -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Company Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-md font-medium text-violet-600">Company Name</p>
                            <p class="text-slate-600">${
                              request.company || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Contact Person</p>
                            <p class="text-slate-600">${
                              request.contact || "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-md font-medium text-violet-600">Contact Email</p>
                            <p class="text-slate-600">${
                              request.contactEmail || "N/A"
                            }</p>
                        </div>
                    </div>
                </div>
<!-- الملفات المرفقة -->
<div class="bg-violet-50 rounded-lg p-4">
    <h4 class="font-bold text-violet-800 mb-2">Attached Files</h4>
    <div class="space-y-2">
        ${
          request.files
            ? `
            <div class="grid grid-cols-1 gap-2">
                <a href="https://backend-production-816c.up.railway.app/${request.files.consentForm}" 
                   download="consent-form-${request._id || 'unknown'}.${request.files.consentForm.split('.').pop()}"
                   class="flex items-center space-x-2 text-violet-600 hover:text-violet-800 bg-white p-3 rounded-lg hover:bg-violet-100 transition-all cursor-pointer w-full text-left">
                    <i class="fas fa-file-alt text-xl"></i>
                    <span>Consent Form</span>
                    <i class="fas fa-download ml-auto"></i>
                </a>
                <a href="https://backend-production-816c.up.railway.app/${request.files.idCard}" 
                   download="id-card-${request._id || 'unknown'}.${request.files.idCard.split('.').pop()}"
                   class="flex items-center space-x-2 text-violet-600 hover:text-violet-800 bg-white p-3 rounded-lg hover:bg-violet-100 transition-all cursor-pointer w-full text-left">
                    <i class="fas fa-id-card text-xl"></i>
                    <span>ID Card</span>
                    <i class="fas fa-download ml-auto"></i>
                </a>
                <a href="https://backend-production-816c.up.railway.app/${request.files.diploma}" 
                   download="diploma-${request._id || 'unknown'}.${request.files.diploma.split('.').pop()}"
                   class="flex items-center space-x-2 text-violet-600 hover:text-violet-800 bg-white p-3 rounded-lg hover:bg-violet-100 transition-all cursor-pointer w-full text-left">
                    <i class="fas fa-graduation-cap text-xl"></i>
                    <span>Diploma</span>
                    <i class="fas fa-download ml-auto"></i>
                </a>
            </div>
            `
            : "<p class='text-violet-700'>No files attached</p>"
        }
    </div>
</div>
              <!-- التعليقات -->
${
  request.reply && request.reply.message
    ? `
<div class="bg-amber-50 rounded-lg p-4">
    <h4 class="font-bold text-amber-800 mb-2">Comments</h4>
    <p class="text-amber-700">${request.reply.message}</p>
</div>
`
    : ""
}
            </div>
        </div>
    `;
      }

      // حفظ التغييرات
      function saveRequestChanges() {
        const requestId = document.getElementById("editRequestId").value;
        const newStatus = document.getElementById("editRequestStatus").value;
        const notes = document.getElementById("editRequestNotes").value;

        const requestIndex = allRequests.findIndex(
          (req) => req._id === requestId
        );
        if (requestIndex !== -1) {
          // تحديث البيانات المحلية
          allRequests[requestIndex].status = newStatus;
          allRequests[requestIndex].adminNotes = notes;

          // تحديث الصف في الجدول
          const row = document.querySelector(
            `tr[data-request-id="${requestId}"]`
          );
          if (row) {
            const statusCell = row.querySelector("td:nth-child(5) span");
            statusCell.textContent =
              newStatus.charAt(0).toUpperCase() + newStatus.slice(1);

            // تحديث لون الحالة
            statusCell.className = `px-4 py-2 rounded-full text-base font-bold shadow capitalize ${
              newStatus === "accepted"
                ? "bg-green-100 text-green-800"
                : newStatus === "rejected"
                ? "bg-red-100 text-red-800"
                : "bg-yellow-100 text-yellow-800"
            }`;
          }

          // إغلاق المودال
          closeModal("editModal");

          // عرض رسالة نجاح
          alert("Request updated successfully!");
        }
      }

      // إغلاق المودال
      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
        document.getElementById(modalId).classList.remove("flex");
        document.body.style.overflow = "auto";
      }

      // وظائف عامة للمودال
      function openModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
        document.getElementById(modalId).classList.add("flex");
        document.body.style.overflow = "hidden";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
        document.getElementById(modalId).classList.remove("flex");
        document.body.style.overflow = "auto";
      }

      // Sidebar Toggle Functionality
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebar = document.querySelector("aside");

      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("-translate-x-full");
      });

      // Close sidebar when clicking outside on mobile
      document.addEventListener("click", (e) => {
        if (window.innerWidth < 1024) {
          if (
            !sidebar.contains(e.target) &&
            !sidebarToggle.contains(e.target)
          ) {
            sidebar.classList.add("-translate-x-full");
          }
        }
      });

      fetch("./Sidebar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("Sidebar-container").innerHTML = data;
          // Initialize navbar functionality
          loadNavbar();
        });

      // فتح مودال العرض
      function openViewModal(requestId) {
        const request = allRequests.find((req) => req._id === requestId);
        if (request) {
          const detailsContent = document.getElementById(
            "requestDetailsContent"
          );

          // عرض مؤشر التحميل
          detailsContent.innerHTML = `
            <div class="flex justify-center items-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-violet-600"></i>
            </div>
          `;

          // عرض المودال
          document.getElementById("viewModal").classList.remove("hidden");
          document.getElementById("viewModal").classList.add("flex");
          document.body.style.overflow = "hidden";

          // عرض البيانات مباشرة
          renderRequestDetails(request);
        }
      }
    </script>
  </body>
</html>
