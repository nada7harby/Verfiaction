<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Requests - SPATRAK Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              violet: {
                200: "#ddd6fe",
                400: "#a78bfa",
                900: "#4c1d95",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="h-full bg-gradient-to-br from-violet-200 via-white to-violet-400"
  >
    <div class="flex h-full">
      <!-- Sidebar -->
      <div id="Sidebar-container"></div>

      <!-- Main Content Area -->
      <div class="flex-1 lg:ml-64">
        <!-- Header -->
        <header
          class="bg-white/80 backdrop-blur-md text-violet-900 shadow-lg fixed w-full lg:w-[calc(100%-16rem)] top-0 z-40"
        >
          <div
            class="container mx-auto px-4 py-3 flex justify-between items-center"
          >
            <div class="flex items-center space-x-4">
              <button
                id="sidebarToggle"
                class="lg:hidden bg-violet-100 text-violet-900 p-2 rounded-lg"
              >
                <i class="fas fa-bars"></i>
              </button>
              <h1 class="text-2xl font-bold">Requests Management</h1>
            </div>
            <div class="flex items-center space-x-4">
              <button
                class="bg-violet-100 hover:bg-violet-200 text-violet-900 px-4 py-2 rounded-lg transition duration-300"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
              </button>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 pt-20 pb-8 overflow-y-auto">
          <!-- Filters and Search -->
          <div
            class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-10 flex flex-col md:flex-row justify-between items-center gap-6"
          >
            <div class="flex items-center space-x-4 w-full md:w-auto">
              <select
                id="statusFilter"
                class="bg-violet-50 border border-violet-200 rounded-lg px-6 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-violet-400 text-violet-900 transition-all"
              >
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
              <select
                id="typeFilter"
                class="bg-violet-50 border border-violet-200 rounded-lg px-6 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-violet-400 text-violet-900 transition-all"
              >
                <option value="all">All Types</option>
                <option value="verification">Verification</option>
                <option value="payment">Payment</option>
                <option value="support">Support</option>
              </select>
            </div>
            <div
              class="flex items-center space-x-4 w-full md:w-auto mt-4 md:mt-0"
            >
              <div class="relative w-full md:w-auto">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search requests..."
                  class="bg-violet-50 border border-violet-200 rounded-lg pl-12 pr-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-violet-400 text-violet-900 w-full transition-all"
                />
                <i
                  class="fas fa-search absolute left-4 top-3.5 text-violet-900 text-lg"
                ></i>
              </div>
              <button
                id="applyFilters"
                class="bg-violet-100 hover:bg-violet-200 text-violet-900 px-6 py-3 rounded-lg text-lg font-semibold shadow transition duration-300 flex items-center"
              >
                <i class="fas fa-filter mr-2"></i>Apply Filters
              </button>
            </div>
          </div>

          <!-- Requests Table -->
          <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-violet-50">
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Request ID
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      User
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Type
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Date
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Status
                    </th>
                    <th
                      class="px-6 py-4 text-left text-base font-bold text-violet-900 uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="requestsTableBody"
                  class="divide-y divide-violet-100"
                >
                  <!-- سيتم ملؤه بالبيانات من الـ API -->
                  <tr>
                    <td
                      colspan="6"
                      class="px-6 py-4 text-center text-violet-900"
                    >
                      Loading requests...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4"
            >
              <div
                id="paginationInfo"
                class="text-base text-violet-600 font-semibold"
              >
                Loading...
              </div>
              <div class="flex items-center space-x-2">
                <button
                  id="prevPage"
                  class="bg-violet-50 text-violet-900 px-4 py-2 rounded-lg hover:bg-violet-100 transition duration-300 font-bold"
                >
                  Previous
                </button>
                <div id="pageNumbers" class="flex items-center space-x-2">
                  <!-- سيتم ملؤه بالبيانات -->
                </div>
                <button
                  id="nextPage"
                  class="bg-violet-50 text-violet-900 px-4 py-2 rounded-lg hover:bg-violet-100 transition duration-300 font-bold"
                >
                  Next
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Edit Request Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-violet-900">Edit Request</h3>
            <button
              onclick="closeModal('editModal')"
              class="text-violet-400 hover:text-violet-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <div class="space-y-4">
            <input type="hidden" id="editRequestId" />

            <div>
              <label class="block text-sm font-medium text-violet-700 mb-1"
                >Status</label
              >
              <select
                id="editRequestStatus"
                class="w-full px-4 py-2 border border-violet-200 rounded-lg focus:ring-2 focus:ring-violet-400 focus:border-violet-400"
              >
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-violet-700 mb-1"
                >Notes</label
              >
              <textarea
                id="editRequestNotes"
                rows="3"
                class="w-full px-4 py-2 border border-violet-200 rounded-lg focus:ring-2 focus:ring-violet-400 focus:border-violet-400"
              ></textarea>
            </div>
          </div>

          <div class="flex justify-end space-x-3 mt-6">
            <button
              onclick="closeModal('editModal')"
              class="px-4 py-2 text-violet-700 bg-violet-100 rounded-lg hover:bg-violet-200 transition"
            >
              Cancel
            </button>
            <button
              onclick="saveRequestChanges()"
              class="px-4 py-2 text-white bg-violet-600 rounded-lg hover:bg-violet-700 transition"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Request Modal -->
    <div
      id="viewModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-y-auto"
    >
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-violet-900">Request Details</h3>
            <button
              onclick="closeModal('viewModal')"
              class="text-violet-400 hover:text-violet-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <div id="requestDetailsContent" class="space-y-6">
            <!-- سيتم ملؤه بالبيانات ديناميكيًا -->
            <div class="flex justify-center items-center py-8">
              <i class="fas fa-spinner fa-spin text-3xl text-violet-600"></i>
            </div>
          </div>

          <div class="flex justify-end mt-6">
            <button
              onclick="closeModal('viewModal')"
              class="px-4 py-2 text-violet-700 bg-violet-100 rounded-lg hover:bg-violet-200 transition"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // المتغيرات العامة
      let allRequests = [];
      let currentPage = 1;
      const itemsPerPage = 10;
      let currentFilters = {
        status: "all",
        type: "all",
        search: "",
      };

      // تهيئة الصفحة
      document.addEventListener("DOMContentLoaded", function () {
        fetchRequests();

        // إعداد معالجات الأحداث
        document
          .getElementById("applyFilters")
          .addEventListener("click", applyFilters);
        document
          .getElementById("searchInput")
          .addEventListener("keyup", function (e) {
            if (e.key === "Enter") applyFilters();
          });
        document
          .getElementById("prevPage")
          .addEventListener("click", goToPrevPage);
        document
          .getElementById("nextPage")
          .addEventListener("click", goToNextPage);

        // إغلاق المودال عند النقر خارجها
        document
          .getElementById("editModal")
          .addEventListener("click", function (e) {
            if (e.target === e.currentTarget) closeModal("editModal");
          });
        document
          .getElementById("viewModal")
          .addEventListener("click", function (e) {
            if (e.target === e.currentTarget) closeModal("viewModal");
          });
      });

      // جلب الطلبات من API
      function fetchRequests() {
        fetch("https://backend-production-816c.up.railway.app/api/requests/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            // معالجة البيانات المستلمة
            if (data && Array.isArray(data)) {
              allRequests = data;
            } else if (data && data.requests && Array.isArray(data.requests)) {
              allRequests = data.requests;
            } else {
              throw new Error("Invalid data format from API");
            }

            // عرض الطلبات
            applyFilters();
          })
          .catch((error) => {
            console.error("Error fetching requests:", error);
            document.getElementById("requestsTableBody").innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-violet-900">
                                Error loading requests. Please try again later.
                            </td>
                        </tr>
                    `;
          });
      }

      // تطبيق الفلاتر
      function applyFilters() {
        currentFilters = {
          status: document.getElementById("statusFilter").value,
          type: document.getElementById("typeFilter").value,
          search: document.getElementById("searchInput").value.toLowerCase(),
        };

        currentPage = 1; // العودة للصفحة الأولى عند تطبيق فلاتر جديدة
        renderRequests();
      }

      // عرض الطلبات مع التصفية والترتيب
      function renderRequests() {
        let filteredRequests = allRequests.filter((request) => {
          // تصفية حسب الحالة
          if (
            currentFilters.status !== "all" &&
            request.status !== currentFilters.status
          ) {
            return false;
          }

          // تصفية حسب النوع (إذا كان موجودًا في البيانات)
          if (
            currentFilters.type !== "all" &&
            request.type &&
            request.type !== currentFilters.type
          ) {
            return false;
          }

          // تصفية حسب البحث
          if (currentFilters.search) {
            const searchStr = `${request.id || ""} ${request.userName || ""} ${
              request.user?.name || ""
            } ${request.type || ""}`.toLowerCase();
            if (!searchStr.includes(currentFilters.search)) {
              return false;
            }
          }

          return true;
        });

        // ترتيب الطلبات حسب التاريخ (الأحدث أولاً)
        filteredRequests.sort(
          (a, b) =>
            new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)
        );

        // التقسيم إلى صفحات
        const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedRequests = filteredRequests.slice(
          startIndex,
          startIndex + itemsPerPage
        );

        // عرض الطلبات في الجدول
        const tableBody = document.getElementById("requestsTableBody");
        tableBody.innerHTML = "";

        if (paginatedRequests.length === 0) {
          tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-violet-900">
                            No requests found matching your criteria
                        </td>
                    </tr>
                `;
        } else {
          paginatedRequests.forEach((request) => {
            const requestDate = request.createdAt
              ? new Date(request.createdAt).toLocaleDateString()
              : "N/A";
            const userName = request.userName || request.user?.name || "N/A";
            const requestType = request.type || "N/A";

            // تحديد لون الحالة
            let statusClass = "bg-gray-100 text-gray-800";
            if (request.status === "accepted") {
              statusClass = "bg-green-100 text-green-800";
            } else if (request.status === "rejected") {
              statusClass = "bg-red-100 text-red-800";
            } else if (request.status === "pending") {
              statusClass = "bg-yellow-100 text-yellow-800";
            }

            const row = document.createElement("tr");
            row.className = "hover:bg-violet-50 transition-all";
            row.dataset.requestId = request._id;
            row.innerHTML = `
                        <td class="px-6 py-5 whitespace-nowrap text-violet-900 text-lg font-semibold">${
                          request._id || "N/A"
                        }</td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex items-center space-x-3">
                                <span class="text-violet-900 text-lg font-semibold">${
                                  request.lastName
                                }</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-violet-900 text-lg">${
                          request.address
                        }</td>
                        <td class="px-6 py-5 whitespace-nowrap text-violet-900 text-lg">${requestDate}</td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="${statusClass} px-4 py-2 rounded-full text-base font-bold shadow capitalize">${
              request.status || "unknown"
            }</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <button onclick="openEditModal('${request._id}')" 
                                        class="text-white bg-violet-600 hover:bg-violet-700 px-3 py-1 rounded-lg transition flex items-center">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button onclick="openViewModal('${request._id}')" 
                                        class="text-violet-700 bg-violet-100 hover:bg-violet-200 px-3 py-1 rounded-lg transition flex items-center">
                                    <i class="fas fa-eye mr-1"></i> View
                                </button>
                            </div>
                        </td>
                    `;
            tableBody.appendChild(row);
          });
        }

        // تحديث معلومات الترقيم
        updatePaginationInfo(filteredRequests.length, totalPages);
      }

      // تحديث معلومات الترقيم
      function updatePaginationInfo(totalItems, totalPages) {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);

        document.getElementById(
          "paginationInfo"
        ).textContent = `Showing ${startItem} to ${endItem} of ${totalItems} entries`;

        const pageNumbersContainer = document.getElementById("pageNumbers");
        pageNumbersContainer.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          const pageBtn = document.createElement("button");
          pageBtn.textContent = i;
          pageBtn.className = `bg-${
            i === currentPage ? "violet-100" : "violet-50"
          } text-violet-900 px-4 py-2 rounded-lg hover:bg-violet-100 transition duration-300 font-bold`;
          pageBtn.addEventListener("click", () => goToPage(i));
          pageNumbersContainer.appendChild(pageBtn);
        }

        // تحديث حالة أزرار الصفحة السابقة/التالية
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled =
          currentPage === totalPages;
      }

      // التنقل بين الصفحات
      function goToPage(page) {
        currentPage = page;
        renderRequests();
      }

      function goToPrevPage() {
        if (currentPage > 1) {
          currentPage--;
          renderRequests();
        }
      }

      function goToNextPage() {
        const totalPages = Math.ceil(allRequests.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderRequests();
        }
      }

      // فتح مودال التعديل
      function openEditModal(requestId) {
        const request = allRequests.find((req) => req._id === requestId);
        if (request) {
          document.getElementById("editRequestId").value = requestId;
          document.getElementById("editRequestStatus").value =
            request.status || "pending";
          document.getElementById("editRequestNotes").value =
            request.adminNotes || "";

          // عرض المودال
          document.getElementById("editModal").classList.remove("hidden");
          document.getElementById("editModal").classList.add("flex");
          document.body.style.overflow = "hidden";
        }
      }

      // فتح مودال العرض
      function openViewModal(requestId) {
        const request = allRequests.find((req) => req._id === requestId);
        if (request) {
          const detailsContent = document.getElementById(
            "requestDetailsContent"
          );

          // عرض مؤشر التحميل
          detailsContent.innerHTML = `
            <div class="flex justify-center items-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-violet-600"></i>
            </div>
        `;

          // عرض المودال
          document.getElementById("viewModal").classList.remove("hidden");
          document.getElementById("viewModal").classList.add("flex");
          document.body.style.overflow = "hidden";

          // عرض البيانات مباشرة
          renderRequestDetails(request);
        }
      }

      // عرض تفاصيل الطلب
      function renderRequestDetails(request) {
        const detailsContent = document.getElementById("requestDetailsContent");
        const requestDate = request.createdAt
          ? new Date(request.createdAt).toLocaleString()
          : "N/A";
        const updatedDate = request.updatedAt
          ? new Date(request.updatedAt).toLocaleString()
          : "N/A";

        // تحديد لون الحالة
        let statusClass = "bg-gray-100 text-gray-800";
        if (request.status === "approved") {
          statusClass = "bg-green-100 text-green-800";
        } else if (request.status === "rejected") {
          statusClass = "bg-red-100 text-red-800";
        } else if (request.status === "pending") {
          statusClass = "bg-yellow-100 text-yellow-800";
        }

        detailsContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- معلومات الطلب الأساسية -->
            <div class="space-y-4">
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Basic Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-violet-600">Request ID</p>
                            <p class="font-medium">${request._id || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Status</p>
                            <p class="font-medium">
                                <span class="${statusClass} px-3 py-1 rounded-full text-sm">${
          request.status || "N/A"
        }</span>
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Created At</p>
                            <p class="font-medium">${requestDate}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Updated At</p>
                            <p class="font-medium">${updatedDate}</p>
                        </div>
                    </div>
                </div>

                <!-- معلومات الشخصية -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Personal Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-violet-600">First Name</p>
                            <p class="font-medium">${request.firstName || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Last Name</p>
                            <p class="font-medium">${request.lastName || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Given Last Name</p>
                            <p class="font-medium">${request.givenLastName || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Birth Date</p>
                            <p class="font-medium">${
                              request.birthDate
                                ? `${request.birthDate.day}/${request.birthDate.month}/${request.birthDate.year}`
                                : "N/A"
                            }</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Email</p>
                            <p class="font-medium">${request.email || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Phone</p>
                            <p class="font-medium">${request.phone || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Address</p>
                            <p class="font-medium">${request.address || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Country</p>
                            <p class="font-medium">${request.country || "N/A"}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- معلومات التعليم والشركة -->
            <div class="space-y-4">
                <!-- معلومات التعليم -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Education Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-violet-600">Establishment</p>
                            <p class="font-medium">${request.establishment || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Program</p>
                            <p class="font-medium">${request.program || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Graduation Year</p>
                            <p class="font-medium">${request.graduationYear || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Internal Reference</p>
                            <p class="font-medium">${request.internalRef || "N/A"}</p>
                        </div>
                    </div>
                </div>

                <!-- معلومات الشركة -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Company Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-violet-600">Company Name</p>
                            <p class="font-medium">${request.company || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Contact Person</p>
                            <p class="font-medium">${request.contact || "N/A"}</p>
                        </div>
                        <div>
                            <p class="text-sm text-violet-600">Contact Email</p>
                            <p class="font-medium">${request.contactEmail || "N/A"}</p>
                        </div>
                    </div>
                </div>

                <!-- الملفات المرفقة -->
                <div class="bg-violet-50 rounded-lg p-4">
                    <h4 class="font-bold text-violet-800 mb-2">Attached Files</h4>
                    <div class="space-y-2">
                        ${
                          request.files
                            ? `
                            <div class="grid grid-cols-1 gap-2">
                                <a href="${request.files.consentForm}" target="_blank" 
                                   class="flex items-center space-x-2 text-violet-600 hover:text-violet-800">
                                    <i class="fas fa-file-alt"></i>
                                    <span>Consent Form</span>
                                </a>
                                <a href="${request.files.idCard}" target="_blank" 
                                   class="flex items-center space-x-2 text-violet-600 hover:text-violet-800">
                                    <i class="fas fa-id-card"></i>
                                    <span>ID Card</span>
                                </a>
                                <a href="${request.files.diploma}" target="_blank" 
                                   class="flex items-center space-x-2 text-violet-600 hover:text-violet-800">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>Diploma</span>
                                </a>
                            </div>
                            `
                            : "No files attached"
                        }
                    </div>
                </div>

                <!-- التعليقات -->
                ${
                  request.comment
                    ? `
                <div class="bg-amber-50 rounded-lg p-4">
                    <h4 class="font-bold text-amber-800 mb-2">Comments</h4>
                    <p class="text-amber-700">${request.comment}</p>
                </div>
                `
                    : ""
                }
            </div>
        </div>
    `;
      }

      // حفظ التغييرات
      function saveRequestChanges() {
        const requestId = document.getElementById("editRequestId").value;
        const newStatus = document.getElementById("editRequestStatus").value;
        const notes = document.getElementById("editRequestNotes").value;

        const requestIndex = allRequests.findIndex(
          (req) => req._id === requestId
        );
        if (requestIndex !== -1) {
          // تحديث البيانات المحلية
          allRequests[requestIndex].status = newStatus;
          allRequests[requestIndex].adminNotes = notes;

          // تحديث الصف في الجدول
          const row = document.querySelector(
            `tr[data-request-id="${requestId}"]`
          );
          if (row) {
            const statusCell = row.querySelector("td:nth-child(5) span");
            statusCell.textContent =
              newStatus.charAt(0).toUpperCase() + newStatus.slice(1);

            // تحديث لون الحالة
            statusCell.className = `px-4 py-2 rounded-full text-base font-bold shadow capitalize ${
              newStatus === "approved"
                ? "bg-green-100 text-green-800"
                : newStatus === "rejected"
                ? "bg-red-100 text-red-800"
                : "bg-yellow-100 text-yellow-800"
            }`;
          }

          // إغلاق المودال
          closeModal("editModal");

          // عرض رسالة نجاح
          alert("Request updated successfully!");
        }
      }

      // إغلاق المودال
      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
        document.getElementById(modalId).classList.remove("flex");
        document.body.style.overflow = "auto";
      }

      // وظائف عامة للمودال
      function openModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
        document.getElementById(modalId).classList.add("flex");
        document.body.style.overflow = "hidden";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
        document.getElementById(modalId).classList.remove("flex");
        document.body.style.overflow = "auto";
      }

      // Sidebar Toggle Functionality
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebar = document.querySelector("aside");

      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("-translate-x-full");
      });

      // Close sidebar when clicking outside on mobile
      document.addEventListener("click", (e) => {
        if (window.innerWidth < 1024) {
          if (
            !sidebar.contains(e.target) &&
            !sidebarToggle.contains(e.target)
          ) {
            sidebar.classList.add("-translate-x-full");
          }
        }
      });

      fetch("./Sidebar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("Sidebar-container").innerHTML = data;
          // Initialize navbar functionality
          loadNavbar();
        });
    </script>
  </body>
</html>
